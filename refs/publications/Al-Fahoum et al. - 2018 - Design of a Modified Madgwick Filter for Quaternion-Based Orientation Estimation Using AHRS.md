See discussions, stats, and author profiles for this publication at: <https://www.researchgate.net/publication/329171121>

Design of a Modiï¬ed Madgwick Filter for Quaternion-Based Orientation
Estimation Using AHRS

ArticleÂ Â inÂ Â International Journal of Computer and Electrical Engineering Â· October 2018

DOI: 10.17706/IJCEE.2018.10.3.174-186

CITATIONS
16

2 authors:

Amjed Al-Fahoum

Yarmouk University

61 PUBLICATIONSÂ Â Â 1,993 CITATIONS

SEE PROFILE

READS
9,375

Momtaz Abadir

Concordia University

3 PUBLICATIONSÂ Â Â 20 CITATIONS

SEE PROFILE

All content following this page was uploaded by Momtaz Abadir on 24 November 2018.

The user has requested enhancement of the downloaded file.

Design of a Modified Madgwick Filter for
Quaternion-Based Orientation Estimation Using AHRS

Amjed S. Al-Fahoum*, Momtaz S. Abadir
School of Engineering Technology, Al Hussein Technical University, Amman, 11831, Jordan.

* Corresponding author. Tel.: +962-65-808774; email: <amjed.fahoum@htu.edu.jo>
Manuscript submitted March 26, 2018; accepted April 15, 2018.
doi: 10.17706/ijcee.2018.10.3.174-186

Abstract:  This  paper  presents  a  quaternion-based  modified  Madgwick  filter  for  real-time  estimation  of
rigid body orientations using attitude and heading reference system (AHRS). The filter consists of a cluster
of a tri-axis accelerometer, a tri-axis magnetometer, and a tri-axis angular rate sensor. The proposed filter
implementation  incorporates  gyroscope  bias  drift  compensation.  Additionally,  an  estimated  magnetic
reference  along  with  low-pass  filter  are  adopted  to  compensate  for  the  magnetic  perturbations.  An
optimized  Levenberg-Marquardt  (LM)  algorithm  is  applied  to  the  Whabaâ€™s  problem  to  obtain  the  body
orientations.  The  hessian  matrix  of  the  algorithm  was  analytically  derived  to  reduce  the  numerical
calculations cost. This algorithm ensures adaptive damped parameter for accurate and fast iterations. The
filter  performs  the calculations of  rotations  using  quaternions  rather  than  Euler  angles,  which  avoids  the
singularities issue associated with attitude estimation. The accelerometer and magnetometer are calibrated
off-line prior to the data fusion process. The magnetometer calibration is made using the ellipsoid fitting
technique. Experimental validation of the filter with the actual sensor data proved to be satisfactory. Testing
cases included the presence of large dynamics and magnetic perturbation were carried out. In all situations
the filter was found to converge and accurately track the rotational motions.

Key  words:  AHRS,  madgwick  filter,  data  fusion,  inertial  measurement  units,  magnetic  distortion,  motion
capture, Whabaâ€™s problem, Levenberg-Marquardt algorithm.

1. Introduction

Computation of accurate heading and position data is an essential mission in most of the tracking motion
systems including  biomechanical systems [1], [2]. Numerous products are found in the market which can
perform the computations accurately. However, they are expensive. It is, therefore, the need of developing a
precise navigation system with a reasonable price is the main target of the many researches in the field. The
Attitude  Heading  Reference  System  (AHRS)  is  based  on  micro-electromechanical  systems  (MEMS)
technology  are  widely  used  in  many  substantial  applications,  such  as  under-water  navigation,  aircraft
guidance  control  and human  body  motion  tracking  [1]-[8].  Systems such  as  automatic  pilots  also use  the
attitude  information  generated by  an  AHRS.  Until  recently, cost-sensitive unmanned aerial  vehicles (UAV)
and general aviation applications mostly relied on AHRS [9].

An  accelerometer  and  magnetometer  measure  the  earth's  gravitational  and  magnetic  field  respectively,
where  an  absolute  reference  of  orientation  can  be  obtained  directly  from  those  measurements.  However,
they  are  most  likely  subjected  to  high  levels  of  external  disturbances.  For  example,  vibrations  due  to
fluctuating motion will distort the pitch and roll angles calculated based on accelerometer gravity vector as

International Journal of Computer Electrical Engineering174Volume 10, Number 3, September 2018

well  as  the  magnetic  disturbances  will  affect  the  calculations  of  the  yaw  angle  [10],  [11].  It  is  also
well-known that the orientations can be obtained using a discrete-time integrator applied to the gyroscope
observations,  in  case  the  initial  condition  are  pre-defined  [12].  Nevertheless,  the  zero-bias  integration  of
gyroscope  observations  will  lead  to  an  accumulating  error  in  the  calculated  orientation.  Hence,  neither  a
combined accelerometer/magnetometer nor the gyroscope can be used as standalone measurement unit.
Therefore, it is a requirement to compute a single estimate of orientation through an optimal fusion filter of
accelerometer, magnetometer, and gyroscope measurements [13].

The problem of finding the optimal attitude estimation, given multiple reference vector correspondences
across the body and sensor frames, was formulated by Whaba in 1965 [14]. Many algorithmic solutions of
Whabaâ€™s  problem  have  been  proposed  in  literature.  Most  of  these  solutions  are  providing  an  optimal
algorithm  using  more  than  a  minimal  set  of  observations  and  finding  the  attitudes  by  minimizing  an
appropriate cost/objective function [3], [8]-[10], [13], the most commonly adopted methods are Extended
Kalman  filtering  (EKF)  and  complementary  filters  [15].  The  Kalman  filtering  techniques  adopt  a
probabilistic  determination  of  the  state  modeled  as  a  Gaussian  distribution.  However,  Kalman  filtering
techniques  are  computationally  expensive.  On  the  other  hand,  A  Complementary  filter  is  a  common
alternative to the EKF due to its simplicity and effectiveness. This simple filter uses the frequency domain
methods  to  filter  out  the  signal  and  obtains  the  estimations  without  any  the  need  to  any  statistical
assumptions [16].

Most  of  the  recent  sensor fusion  algorithms  for  inertial/magnetic  sensors  are  designed  to  perform  the
orientation  estimation  in  quaternion  form.  Quaternions  are  part  of  a  powerful  mathematical  tool  which
requires  less  computation  time  because  of  their  minimal  number  of  parameters  [16],  [17].  Additionally,
they avoid the singularity configurations unlike the Euler representation.

Euston et al. [18] carried out a non-linear quaternion-based complementary filter to estimate the attitude

from a low-cost Inertial Measurement Unit (IMU) observations.

Recently,  Madgwick  et  al.  [19]  presented  a  simplistic  filtering  approach,  where  a  fixed  gain  filter  is
adopted to estimate the attitude in quaternion form of a rigid body by using data from AHRS observations.
Madgwickâ€™s filter splits the problem into stages as follows: (1) First quaternion estimation is obtained by
the  integration  of  gyroscope  output,  (2)  and  later  it  is  corrected  by  a  quaternion  estimates  from  the
accelerometer  and  magnetometer  measurements  computed  through  a  gradient  descent  algorithm.
Madgwickâ€™s method maintains good attitude estimation at low computational cost. Furthermore, it handles
the local magnetic disturbances that, when present, affect all the orientation components (roll, pitch, and
yaw). By reducing the constraint of the magnetic field vector rotation, it can limit the effect of the magnetic
disturbances to only affect the yaw component of the orientation. The two fixed gain filters developed by
Euston  et.  al.  and  by  Madgwick  et.  al.,  are  commonly  used  because  they  offer  good  performances  at  low
computational cost [20].

In this work, Madgwickâ€™s filter was chosen to be the core base of the proposed filter due to its accuracy at
relatively  low  computational  cost.  However,  the  filter  was  modified  by  replacing  the  gradient-descent
algorithm with an optimized Levenberg-Marquardt (LM) algorithm to solve the Whabaâ€™s problem. The LM
advantages  among  the  original  gradient-descent  algorithm  is  seen  from  its  capability  to  adapt  the
convergence  rate  of  the  iterations.  Consequently,  an  adaptive  damping  strategy  is  implemented  with  the
optimization step. Moreover, the magnetic distortion was treated more deeply by applying a low-pass filter
for the magnetometer raw data prior to the filter algorithm itself. The use of low-pass filter will reduce the
effect  of  the  magnetic  distortion  on  the  yaw  angle,  this  is  another  modification  to  the  original  magnetic
compensator used by Madgwickâ€™s filter.

A complete derivation of the proposed filter is presented in this work. Experimental tests were conducted

International Journal of Computer Electrical Engineering175Volume 10, Number 3, September 2018

to evaluate the performance of the filter under aggressive condition of rapid magnetic distortion. Procedure
for Paper Submission

2. Mathematical Modeling

2.1.

  Orientation Derived from Angular Rate

Orientation  can  be  defined  as  a  set  of  parameters  that  relates  the  angular  position  of  sensor  frame  to
earth  reference  frame.  In  most  often,  Euler  angles  and  quaternions  are  used.  A  tri-axis  gyroscope  will
provide  the  angular  rate  about  the  ğ‘¥,  ğ‘¦  and  ğ‘§  axes  of  the  sensor  frame,  termed  ğœ”ğ‘¥ ,  ğœ”ğ‘¦   and  ğœ”ğ‘§
respectively. If these parameters (in  ğ‘Ÿğ‘ğ‘‘ğ‘  âˆ’1) are arranged into the vector  ğœ”ğ‘¡  at time  ğ‘¡, defined by Eq. 1,
the quaternion derivative describing rate of change of the earth frame relative to the sensor frame  ğ‘Ì‡ğœ”,ğ‘¡  can
be  calculated  [13]  as  Eq.  2.  The  âŠ—  operator  denotes  a  quaternion  product,  the  Ë† accent  denotes  a
normalized vector of unit length and  ğ‘Ì‚ğ‘’ğ‘ ğ‘¡,ğ‘¡âˆ’1  is latest estimated quaternion.

ğœ”ğ‘¡ =   [0 ğœ”ğ‘¥ ğœ”ğ‘¦   ğœ”ğ‘§ ]

ğ‘Ì‡ğœ”,ğ‘¡ =

1

2

 . ğ‘Ì‚ğ‘’ğ‘ ğ‘¡,ğ‘¡âˆ’1 âŠ— ğœ”ğ‘¡

(1)

(2)

It  is,  therefore  the  orientation  of  earth  frame  relative  to  the  sensor  frame  at  time  ğ‘¡,  ğ‘ğœ”,ğ‘¡  is  computed
using a discrete-time integrator. The quaternion derivatives  ğ‘Ì‡ğœ”,ğ‘¡  are then numerically integrated, provided
that the initial conditions are pre-defined.

ğ‘ğœ”,ğ‘¡ = ğ‘Ì‚ğ‘’ğ‘ ğ‘¡,ğ‘¡âˆ’1 + ğ‘Ì‡ğœ”,ğ‘¡âˆ†ğ‘¡

(3)

Note,  that  ğœ”ğ‘¡  in  these  equations  is  a  4 Ã— 1  vector  with  zero  first  element  and  the  gyroscope  angular
rates measured at time  ğ‘¡,  âˆ†ğ‘¡  is the sampling rate of the filter. Sub-script  ğœ”  indicates that the quaternion
is calculated from angular rates.

2.2.

  Orientation Derived from Accelerometer and Magnetometer Cluster

Since,  the  accelerometer  and  magnetometer  data  are  not  in  direct  relation  to  the  orientation  angles,  a
different approach is used based on Whabaâ€™s problem, which formulates the problem in cost function. This
problem  using  the  minimum-squared-error  (MSE)  approach.  It  is  found  that  error  can  be  minimized  in
either the sensor frame or in the earth frame. Error minimized in the sensor frame is adopted in this work.
Now, if  ğœ€ is assumed to be the error, then the cost function is defined as:

   ğœ€ğ‘‡ğœ€ =   ğ‘§ğ‘¡ âˆ’ ğ‘€ğ‘¡ Ã— ğ‘§ğ‘’

(4)

where,  ğ‘§ğ‘¡  is  a  6 Ã— 1  vector  with  the  measurements  of  gravity  and  magnetic  field  in  the  sensor  frame  at
time  ğ‘¡, and  ğ‘§ğ‘’  is a  6 Ã— 1  vector with reference values of gravity and magnetic field in the earth frame.
where  ğ‘€ğ‘¡  is a diagonal matrix, it represents the current time Direction Cosine Matrix (DCM) which rotates
both the measurements vectors:

The matrix  ğ‘…ğ‘¡  in Eq. 5 is defined by Eq. 6 as follows:

ğ‘€ğ‘¡ =   [

0
ğ‘…ğ‘¡
0 ğ‘…ğ‘¡

]

ğ‘…ğ‘¡ =   [

2 âˆ’ ğ‘3

2 âˆ’ ğ‘2

2 2. (ğ‘1. ğ‘2 + ğ‘3. ğ‘4)
2 + ğ‘4
ğ‘1
2
2 âˆ’ ğ‘3
2. (ğ‘1. ğ‘2 âˆ’ ğ‘3. ğ‘4) ğ‘2
2. (ğ‘1. ğ‘3 + ğ‘2. ğ‘4) 2. (ğ‘2. ğ‘3 âˆ’ ğ‘1. ğ‘4)

2 + ğ‘4

2 âˆ’ ğ‘1

(5)

(6)

2. (ğ‘1. ğ‘3 âˆ’ ğ‘2. ğ‘4)
2. (ğ‘2. ğ‘3 + ğ‘1. ğ‘4)
2
2 âˆ’ ğ‘2
2 âˆ’ ğ‘1
2 + ğ‘4
ğ‘3

]

International Journal of Computer Electrical Engineering176Volume 10, Number 3, September 2018

The  quaternion  convention  that  is  used  in  this  work  is  the  same  of  [21],  ğ‘ğ‘¡  with  ğ‘4  as  the  real

component.

And hence,  ğ‘§ğ‘¡  is measured by the accelerometer and magnetometer sensors and  ğ‘§ğ‘’  is known, the error
between them is a function of the matrix  ğ‘€ğ‘¡, this error depends on quaternion components. Thus, the main
target is to find iteratively the values of quaternion components that yield the minimum error (i.e.  ğœ€ â‰ˆ 0).

In the Madgwickâ€™s filter approach the  gradient-descent algorithm was used to find the solution for this
optimization problem. However, this algorithm follows fixed damping strategy [22], this in turn reduces the
accuracy  whenever  solutions  require  large  or  small  step-size.  LM  algorithm  provides  better  accuracy  in
terms of its ability to perform variable damping strategy by updating the step-size of the solation at each
iteration [23]. By applying the Levenberg-Marquardt update rule on the cost function in Eq. 4,

where  ğµ  approximates Hessian matrix (ğµ = ğ½ğ‘‡ğ½) and  ğ½  is Jacobian matrix defined in Eq. 8.

ğ‘˜ =   ğ‘ğ‘’ğ‘ ğ‘¡,ğ‘¡
ğ‘ğ‘’ğ‘ ğ‘¡,ğ‘¡

ğ‘˜âˆ’1 âˆ’ (ğµ + ğœ†. ğ‘‘ğ‘–ğ‘ğ‘”[ğµ])âˆ’1ğ½ğ‘‡ğœ€

ğ½ = âˆ’ *(

ğœ•ğ‘€
ğœ•ğ‘1

) . ğ‘§ğ‘’    (

ğœ•ğ‘€
ğœ•ğ‘2

) . ğ‘§ğ‘’    (

ğœ•ğ‘€
ğœ•ğ‘3

) . ğ‘§ğ‘’   (

ğœ•ğ‘€
ğœ•ğ‘4

) . ğ‘§ğ‘’+

(7)

(8)

ğ‘˜

where  ğ‘ğ‘’ğ‘ ğ‘¡,ğ‘¡
iterations based on the LM algorithm depends on convergence rate (i.e.  ğ‘˜(âˆ†ğœ€)),

  is  updated  estimate  after  total  number  of  iterations  ğ‘˜,  at  time  ğ‘¡.  The  total  number  of

The convergence criterion can then be best achieved based on the following damped stagey [23]:

âˆ†ğœ€ğ‘˜ =   ğœ€ğ‘˜ âˆ’ ğœ€ğ‘˜âˆ’1

ğœ†

         ğ‘–ğ‘“ âˆ†ğœ€ğ‘˜   < âˆ†ğœ€ğ‘˜âˆ’1
ğœ† = {
ğ›½
ğœ†. ğ›½     ğ‘–ğ‘“ âˆ†ğœ€ğ‘˜   â‰¥ âˆ†ğœ€ğ‘˜âˆ’1

(9)

(10)

where,  ğœ†  is  called  the  damping  parameter.  The  damping  parameter  is  then  adjusted  at  each  iteration  at
time    , corresponding to the value of  âˆ†ğœ€ğ‘˜. The adjusting rate is fixed and denoted by  ğ›½  which is called the
decay rate. For a relaxed optimization solution with small oscillations, initial value of  ğœ†  will be chosen to be
close  to  zero,  and  typical  decay  rate  ranges,  0 <  ğ›½ < 10.  Now,  based  on  Eq.  10,  if  âˆ†ğœ€ğ‘˜   â‰¥ âˆ†ğœ€ğ‘˜âˆ’1  the
estimate is rejected and  ğœ†  is increased by a factor of  ğ›½  and if  âˆ†ğœ€ğ‘˜   < âˆ†ğœ€ğ‘˜âˆ’1  the estimate is accepted and
ğœ†  is reduced by a factor of  ğ›½. Finally, the estimated rate can be defined as follows:

ğ‘Ì‡ğ‘’ğ‘ ğ‘¡,ğ‘¡âˆ†ğ‘¡ = ğ‘ğ‘’ğ‘ ğ‘¡,ğ‘¡ âˆ’ ğ‘Ì‚ğ‘’ğ‘ ğ‘¡,ğ‘¡âˆ’1

(11)

3. Propsed Modified Filter Algorithm

3.1.

  Data Fusion Algorithm

The fusion of the quaternion estimates, ğ‘ğ‘“ğ‘–ğ‘™ğ‘¡ğ‘’ğ‘Ÿ,ğ‘¡  are obtained from both gyroscope angular rates,  ğ‘ğœ”,ğ‘¡and
  is performed by Eq. 12 where  ğœ‡  and  (1 âˆ’ ğœ‡)  are fixed

ğ‘˜

the accelerometer and magnetometer data,  ğ‘ğ‘’ğ‘ ğ‘¡,ğ‘¡
weights applied to each estimation.

ğ‘ğ‘“ğ‘–ğ‘™ğ‘¡ğ‘’ğ‘Ÿ,ğ‘¡ = ğœ‡. ğ‘ğ‘’ğ‘ ğ‘¡,ğ‘¡ + (1 âˆ’ ğœ‡). ğ‘ğœ”,ğ‘¡ , 0 â‰¤ ğœ‡ â‰¤ 1

(12)

An optimal fusion can be exhibited by assuming weighted convergence rate of  ğ‘ğ‘’ğ‘ ğ‘¡,ğ‘¡

  is equal or greater
than physical rate of change of  ğ‘ğœ”,ğ‘¡  . Therefore, a large value of  ğœ‡  is preferable as long as it will not affect
the computational cost significantly and reduce the overall speed of the filter.

ğ‘˜

International Journal of Computer Electrical Engineering177Volume 10, Number 3, September 2018

3.2.

  Magnetic Distortion Compensator

Magnetic distortions affect the performance of orientations estimation and it has radical errors that may
be  introduced  by  various  sources  including  electrical  appliances,  metal  furniture  and  metal  structures
within  a  buildings  construction  [24].  However,  these  sources  of  perturbations  can  be  reduced,  if  an
additional reference of orientation is available [13].

The magmatic reference of the earthâ€™s magnetic field in the earth frame at time  ğ‘¡,  ğ‘•ğ‘¡, can be computed as,

ğ‘•ğ‘¡ = ğ‘Ì‚ğ‘’ğ‘ ğ‘¡,ğ‘¡âˆ’1 âŠ— ğ‘šÌ‚  ğ‘¡ âŠ— ğ‘Ì‚ğ‘’ğ‘ ğ‘¡,ğ‘¡âˆ’1

âˆ—

(13)

where,  ğ‘šÌ‚  ğ‘¡   is  normalized  magnetometer  observations  vector  at  time  ğ‘¡,  and  ğ‘Ì‚ğ‘’ğ‘ ğ‘¡,ğ‘¡âˆ’1
  is  conjugate  of
ğ‘Ì‚ğ‘’ğ‘ ğ‘¡,ğ‘¡âˆ’1.  Since,  the  magnetic  reference  does  not  have  a  component  aligned  with  ğ‘¦  axis,  the  effect  of  an
erroneous inclination of the measured direction earthâ€™s magnetic field,  ğ‘•ğ‘¡, can be corrected. Thus, if  ğ‘ğ‘¡, is
of the same inclination, it can be found by estimating  ğ‘•ğ‘¡  as  ğ‘•ğ‘¡  normalised to have only components in the
earth frame  ğ‘¥  and  ğ‘§  axes; as described in Eq. 14.

âˆ—

ğ‘ğ‘¡ =   [0 âˆšğ‘•ğ‘¥

2 + ğ‘•ğ‘¦

2 0   ğ‘•ğ‘§ ]

(14)

This  approach  ensures  that  the  magnetic  distortion  affects  only  the  yaw  angle  (i.e.,  the  heading
orientation).  It  also  avoids  the  need  to  set  a pre-defined  reference  direction  of the  earthâ€™s  magnetic field.
However,  in  the  proposed  filter  ğ‘šÌ‚  ğ‘¡  observations  are  introduced  to  a  low-pass  filter  to  eliminate  the
distortion effects on heading orientation as well. This is simply illustrated in Fig. 1

Fig. 1. Low-Pass filter to compensate for magnetic distortion effect on the heading estimate.

3.3.

  Gyroscope Bias Drift Compensator

It  is  well-known  that  the  gyroscope  constant  bias  will  grow  linearly  over  time.  It  is  simply  can  be
compensated  by  estimating  constant  bias  offsets.  However,  due  to  motion  and  ambient  factors  a  high
frequency noise (usually in form of white Nosie) will drift over time to create an accumulated effect on the
integration of orientations. In practical applications this drift must be minimized to a lower level. Mahony et
al. [25] suggested that the gyroscope bias drift may be compensated for by a simple integral feedback of the
error in the rate of change of orientation. This algorithm can be best described by the following equations,

ğœ”ğ‘’ğ‘Ÿğ‘Ÿğ‘œğ‘Ÿ,ğ‘¡ =  2 . ğ‘Ì‚ğ‘’ğ‘ ğ‘¡,ğ‘¡âˆ’1

âˆ—

âŠ— ğ‘Ì‡ğ‘’ğ‘ ğ‘¡,ğ‘¡

ğœ”ğ‘,ğ‘¡ =  ğœ âˆ‘ ğœ”ğ‘’ğ‘Ÿğ‘Ÿğ‘œğ‘Ÿ,ğ‘¡ âˆ†ğ‘¡

ğœ”ğ‘,ğ‘¡ =   ğœ”ğ‘,ğ‘¡ âˆ’ ğœ”ğ‘’ğ‘Ÿğ‘Ÿğ‘œğ‘Ÿ,ğ‘¡

(15)

(16)

(17)

The gyroscope bias,  ğœ”ğ‘,ğ‘¡  is found from the DC component of  ğœ”ğ‘’ğ‘Ÿğ‘Ÿğ‘œğ‘Ÿ,ğ‘¡  and so it can be removed as the
integral  of  ğœ”ğ‘’ğ‘Ÿğ‘Ÿğ‘œğ‘Ÿ,ğ‘¡  weighted  by  the  gain,  ğœ  as  in  Eq.  16.  This  will  result  in  compensated  gyroscope
measurement,  ğœ”ğ‘,ğ‘¡. This later result will be used instead of the original gyroscope observations vector, ğœ”ğ‘¡.

International Journal of Computer Electrical Engineering178Volume 10, Number 3, September 2018

3.4.

  Filter Algorithm Implementation

The  proposed  filter  algorithm  was  developed  in  MatLab/Simulink  environment.  A  rapid  approach  had
been  adopted  using  Simulink  Real-time  package  for  embedded  coder  for  direct  code  generation  for  the
target  system.  Additionally,  the  target  enables  designers  to  monitor  and  tune  algorithms  running  on
Arduino board from the same Simulink models.

An Arduino Mega 2560 was  used  as platform to test the filter. Arduino Mega 2560 is a microcontroller
board based on the ATmega2560. The choice of this controller was only to test the ability of the proposed
filter with low-cost open source board such Arduino Mega 2560.

The proposed filter algorithm is demonstrated in Fig. 2. It illustrates the LM-estimator and the other main
components of the filter such as  the magnetic distortion and reference, discrete-time integrator and drift
compensator sub-system.

Fig. 2. Block diagram representation of the proposed filter for the AHRS data including the magnetic
compensator and the low-pass filter.

4. Filter Validation and Tests

4.1.

  Sensors Calibration and Tests Conditions

The AHRS data were obtained using the GY-85, low cost 9-DoF cluster of tri-axis accelerometer, tri-axis
magnetometer and tri-axis  gyroscope.  The  test  was  conducted at  relatively  low  frequency  of  10 ğ»ğ‘§.  Both
accelerometer  and  magnetometer  raw  data  were  calibrated  using  ellipsoid  fitting  method  [26].  The
distribution of the magnetometer raw data before and after calibration are presented in Fig. 3 and Fig. 4,
respectively.

The accelerometer was found to have suitable distribution by only using the sensitivity gains provided by
the  manufacturing  sheet  without  the  need  for  any  further  calibration  process.  On  the  other  hand,  the
gyroscope constant bias was accounted for by taking the average for  10 ğ‘ ğ‘’ğ‘; starting from the initialization
of the filter and then subtract this average from the gyroscope raw data for each axis.

International Journal of Computer Electrical Engineering179Volume 10, Number 3, September 2018

Fig. 3. Before calibration: Magnetometer raw data is showing a shifted ellipsoid.

Fig. 4. After calibration: Magnetometer raw data is showing a centered semi-spherical distribution.

4.2.

  Performance Evaluation of the Proposed Filter

The  filter  convergence  attitude  to  a  pre-defined  steady-state  was  first  tested  by  performing  a

double-rotation as shown in Fig. 5.

Fig. 5. Convergence of pitch angle from  0o  to  90o  steady-state conditions.

It  is  clear  from  the  above  test  that  the  filter  at  the  defined  initial  gains  approached  the  steady-state
orientation in a fast and moderate accuracy trend. The static RMS (Root-Mean-Square) error was estimated
with respect to the reference pitch angle. A residual plot of static test for the pitch angle is shown in Fig. 6.
The static RMS was then calculated and found to be  ğŸ. ğŸ‘ğŸ•ğ¨.

International Journal of Computer Electrical Engineering180Volume 10, Number 3, September 2018

Fig. 6. Error vs. time plot of static pitch angle test.

Later,  the  sensor  platform was  subjected  to  aggressive  base-excitation  (High  frequency  vibrations),  the

result is shown in Fig. 7. The dynamics RMS at this aggressive condition was found to be  ğŸ”. ğŸ“ğ¨.

The  magnetic  distortion  algorithm  that  was  adopted  in  the  current  was  validated  by  applying  a  high

amplitude-frequency magnetic perturbation around the sensor surrounding field.

Fig.  8  shows  the  heading  angle  after  the  magnetic  distortion  was  compensated  for  using  the  low-pass
filter. The distortion effect on the normalized magnetometer raw data is evident, a comparison between the
compensated  and  the  un-compensated  raw  data  in  Fig.  8  proves  the  ability  of  the  FIR-lowpass  filter  to
eliminate the high frequency magnetic perturbations.

Fig. 7. Error vs. time plot of aggressive base-excitation pitch angle test.

Fig. 8. Magnetic distortion in heading angle compensated using FIR-lowpass filter.

The  filter  damping  paramter  behavior  during  different  static  and  dynamic  rotations  around  the

International Journal of Computer Electrical Engineering181Volume 10, Number 3, September 2018

three-axes  of  the  AHRS  was  analyzed.  Fig.  9,  investigates  the  damped  strategy  of  LM  algorithm,  the
maximum number of iteration at each time  ğ‘¡, was also examined along with associated Euler estimates (see
Fig.  10).  This  test  was  conducted  for  ğœ† = 0.001  and  ğ›½ = 10,  where  the  ğœ  was  fixed  at  0.041  and  the
fixed  weight  filter  gain  was  fixed  to  0.92.  These  values  were  chosen  basically  to  ensure  high  accurate
estimates regardless of their effect on the filter speed.

It  was  found  from  the  previous  test  that  filter  damping  parameter  adjusts  itself  repeatedly  at  the
initialization  of  the  process.  It  also  was  noticed  that  the  damping  parameter  reached  the  maxima  when
rapid oscillations in the orientations occurred as seen from Fig. 9 and Fig. 10. The trend of the maximum
number of iterations per sample was observed to behave similarly as the damping parameter. However, at
the steady-state conditions the maximum number of iterations approached an average of two iterations.

Fig. 9. The LM damping parameter and the maximum iteration number during the fusion process.

Fig. 10. Euler estimates during the damped strategy investigation study.

The  value  of  ğœ‡ = 0.92  corresponds  to  the  LM-estimator  term  in  Eq.  12.  This  in  turns  acts  quite  as
high-pass filter with respect to the accelerometer and magnetometer measurements. On the contrary, it acts
as  low-pass  filter  with  respect  to  the  gyroscope  measurements.  The  value  of  ğœ†  and  ğ›½  were  relaxed  by
increasing  them  to  . 1  and  1,  repectively.  After  filter  relaxation,  a  modest  accuracy  (acceptable)  and  fast
filter speed was observed. A tracking test was obtained during the filter relaxation for both the quaternions
and Euler estimates as described in Fig. 11-Fig. 13.

It is seen from Fig. 11 at  2 < ğ‘¡ < 10 ğ‘ ğ‘’ğ‘  that the Euler angles are  ğ›· = 0, ğœƒ = 0, ğœ“ =   âˆ’100, which are
later

following  quaternion  vector  ğ‘2<ğ‘¡<10 = [0.581 ,0.0 , 0.0, âˆ’0.814] .  This

corresponding  to  the
observation is confirmed from Fig. 12 and Fig. 13.

Fig.  13  shows  clearly  that  the  quaternion  estimates  obtained  from  gyroscope  measurements  are  more

International Journal of Computer Electrical Engineering182Volume 10, Number 3, September 2018

rapid, the reason of this comes from the fact the gyroscope sampling time is higher among the other sensors
in the AHRS cluster.

In  general,  the  results  obtained  from  Fig.  11-Fig.  13  showed  that  the  proposed  filter  has  a  fast
convergence  rate.  It  was  also  noticed  that  filter  most  often  approaches  the  steady-state  from  the  initial
condition  in  suitable  period.  The  LM  algorithm  was  seen  to  adjust  the  optimization  problem  whenever
massive oscillations were detected.

Fig. 11. Tracking test results: Filter Euler angles estimates.

Fig. 12. Tracking test results: LM algorithm quaternions estimates.

Fig. 13. Tracking test results: Gyroscope angular rate based-quaternions estimates.

5. Conclusion

In this paper, a modified algorithm to speed up the convergence and accuracy of Madgwickâ€™s filter was
presented.  In  this  modified  algorithm  the  original  gradient-descent  algorithm  was  replaced  by

International Journal of Computer Electrical Engineering183Volume 10, Number 3, September 2018

the
Levenberg-Marquardt  algorithm.  This  modification  can  be  seen  as  an  advantage,  since
Levenberg-Marquardt algorithm provides the fusion process with a damped strategy through the definition
of the damping parameter and decay rate. The damping parameter is found to influence both the accuracy
and the speed of convergence of the filter.

The results of this work reveal a better accuracy in the situation where rapid oscillations do exist. Hence,
the dynamics root-mean-square at aggressive vibration conditions was found to be relatively small (ğŸ”. ğŸ“ğ¨).
Whereas the static root-mean-square shows preferable values with a low value of  ğŸ. ğŸ‘ğŸ•ğ¨.

The  filter  was  tested  under  high  amplitude  and  frequency  external  magnetic  perturbations,  the  results
showed  good  compensation  for  these  distortions  and  it  was  not  limited  to  any  of  the  estimates.  The
modified  filter  can  be  easily  adopted  for  real  life  scenarios  and  on-line  applications.  Accordingly,  several
applications in navigation systems and biomechanical applications can be adopted as well.

Acknowledgment

Our  thanks  to  Al  Hussein  Technical  University  Technology  Center  to  facilitate  the  setup  of  the
experiments  and  their  financial  and  technical  support.  Also,  thanks  to  Yarmouk  University  for  their
continuous support to HTU. It  is worth mentioning that Dr. Amjed Al-Fahoum is on leave of absence from
Yarmouk University.

References

[1]  Al-Fahoum,  A.,  &  Gharaibeh,  K.  H.  (2014).  Prediction  of  sagittal  lower  limb  joints  moments  under
dynamic condition: Feasibility of using EMG and ARMA model identification techniques. International
Journal of Experimental and Computational Biomechanics, 2.

[2]  Al-Fahoum, A., & Gharaibeh, K. H.  (2015). Feasibility study for Anfis and Emg utilization in modeling
prosthesis  for  trans-femoral  cut  rehabilitation  and  gait  cycle  restoration.  Biomed.  Eng.  Appl.  Basis
Commun., 27(3), 1550023.

[3]  Yadav,  N.,  &  Bleakley,  C.  (2014).  Accurate  orientation  estimation  using  AHRS  under  conditions  of

magnetic distortion. Sensors (Switzerland), 14(11), 20008-20024.

[4]  Abbate,  N.,  Basile,  A.,  Brigante,  C.,  &  Faulisi,  A.  (2009,  May  21-23).  Development  of  a  MEMS  based
wearable motioncapture system. Proceedings of the 2009 2nd Conference on Human System Interactions
(HSIâ€™09) (pp. 255-259). Catania, Italy.

[5]  Wendel,  J.,  Meister,  O.,  Schlaile,  C.,  &  Trommer,  G.  (2006).  An  integrated  GPS/MEMS-IMU  navigation

system for an autonomous helicopter. Aerosp. Sci. Technol., 10, 527-533.

[6]  Armstrong,  B.,  Wolbrecht,  E.,  &  Edwards,  D.  (2010,  May  24-27).  AUV  navigation  in  the  presence  of  a
magnetic disturbance  with an extended Kalman filter. Proceedings of the Oceans 2010 IEEE (pp. 1-6).
Sydney, Australia.

[7]  Roetenberg,  D.,  Luinge.  H.,  Baten,  C.,  &  Veltink,  P.  (2005).  Compensation  of  magnetic  disturbances
improves inertial and magnetic sensing of human body segment  orientation. IEEE Trans. Neural Syst.
Rehabil. Eng., 13(3), 395-405.

[8]  Yun,  X.,  &  Bachmann,  E.  (2006).  Implementation  and  Experimental  Results  of  a  Quaternion-Based
Kalman Filter for Human Body Motion Tracking. Proceedings of the 2005 IEEE Int. Conf. Robot. Autom.:
vol. 22. (pp. 317-322).

[9]  Gebre-Egziabher, D., Hayward, R., & Powell, J. D. (2004). Design of multi-sensor attitude determination

systems. IEEE Trans. Aerosp. Electron. Syst., 40(2), 627-649.

[10] Valenti, R. G., Dryanovski, I., & Xiao, J. (2015). Keeping a good attitude: A quaternion-based orientation

filter for IMUs and MARGs. Sensors (Switzerland), 15(8), 19302-19330.

International Journal of Computer Electrical Engineering184Volume 10, Number 3, September 2018

[11] Renaudin,  V.,  Afzal,  M.  H.,  &  Lachapelle,  G.  (2010).  New  method  for  magnetometer  based  orientation

estimation. Proceedings of the IEEE/ION Position, Locat. Navig. Symp. (pp. 348-356).

[12] Ignagni, M. B. (2012). Optimal strapdown attitude integration algorithms. Journal of Guidance Control &

Dynamics, 13(2), 363-369.

[13] Madgwick, S., Harrison, A., & Vaidyanathan, R. (2011). Estimation of IMU and MARG orientation using a

gradient descent algorithm. Proceedings of the IEEE Int. Conf. Rehabil. Robot (pp. 179-185).

[14] Wahba,  G.  (1965).  A  least  square  estimate  of  spacecraft  attitude.  Soc.  Ind.  Appl.  Math.  (SIAM)  Rev.,  7,

409-1965.

[15] Crassidis,  J.  L.,  Markley,  F.  L.,  &  Cheng,  Y.  (2007).  Survey  of  nonlinear  attitude  estimation  methods.  J.

Guid. Control Dyn., 30, 12-28.

[16] Tanveer, F., Waheed, O. T., & Rehman, A. (2011). Design and development of a sensor fusion based low

cost attitude estimator. J. Sp. Technol., 1(1).

[17] Kuipers,  J.  B.  (1999).  Quaternions  and  Rotation  Sequences:  A  Primer  with  Applications  to  Orbits,

Aerospace and Virtual Reality. Princeton, NJ, USA: Princeton University Press.

[18] Euston,  M.,  Coote,  P.,  Mahony,  R.,  &  Hamel,  T.  (2008,  September  22-26).  A  complementary  filter  for
attitude  estimation  of  a  fixed-wing  UAV.  Proceedings  of  the  IEEE/RSJ  International  Conference  on
Intelligent Robots and Systems (pp. 340-345). Nice, France.

[19] Madgwick, S., Harrison, A., & Vaidyanathan, A. (2011). Estimation of IMU and MARG orientation using a
gradient descent algorithm. Proceedings of the IEEE International Conference on Rehabilitation Robotics
(pp. 1-7). Zurich, Switzerland.

[20] Alam,  F.,  ZhaiHe,  Z.,  &  Jia,  H.  A.  (2014,  March  21-22).  Comparative  analysis  of  orientation  estimation
filters  using  MEMS  based  IMU.  Proceedings  of  the  International  Conference  on  Research  in  Science,
Engineering and Technology. Dubai, UAE.

[21] Marins, J. L., Yun, X., Bachmann, E. R., McGhee, R. B., & Zyda, M. J. (2011). An extended Kalman filter for
quaternion-based  orientation  estimation  using  MARG  sensors.  Proceedings  of  the  2001  IEEE/RSJ  Int.
Conf. Intell. Robot. Syst. Expand. Soc. Role Robot. Next Millenn.: vol. 4. (pp. 2003-2011).

[22] Nocedal, J., & Wright, S. J. (1999). Numerical Optimization. New York: Springer.
[23] Kwak,  Y.,  Hwang,  J.,  &  Yoo,  C.  (2011).  Levenberg-marquardt  algorithm  for  multilayer  perceptrons.

Neural Network World, 327-340.

[24] Bachmann,  E.  R,  Yun,  X.,  &  Peterson,  C.  W.  (2004,  Apr.).  An  investigation  of  the  effects  of  magnetic
variations  on  inertial/magnetic  orientation  sensors.  Proceedings  of  the  IEEE  International  Conference
on Robotics and Automation ICRA â€™04: vol. 2. (pp. 1115-1122).

[25] Mahony, R., Hamel, T., & Pimlin, J.-M. (2008). Nonlinear complementary filters on the special orthogonal

group. IEEE Transactions on Automatic Control, 53(5), 1203-1218.

[26] Turner, D. A., Anderson, I. J., Mason, J. C. (1999). An Algorithm for Fitting and Ellipsoid to Data (Technical

Report No. RR9803). School of Computing and Mathematics, University of Huddersfield.

Amjed  S.  Al-Fahoum  has  more  than  25  years  of  industrial  and  academic  experience.
Currently  he  is  serving  as  the  dean  of  School  of  Engineering  Technology  (SET)  at
Al-Hussein Technical University. Previously, he served as project manager and vice dean
for  accreditation  and  quality  assurance  at  Al  Quds  College  and  the  president  of  the
board  of  trustees  for  Zarqa  National  Community  College.  Before  that,  he  served  at
Yarmouk  University  and  Princess  Sumayah  University  for  Technology  as  an  academic
professor.  Dr.  Al  Fahoum  was  appointed  for  two  terms  as  the  chairman  for  the

International Journal of Computer Electrical Engineering185Volume 10, Number 3, September 2018

Biomedical  Systems  and  Informatics  Engineering  Department,  a  director  of  the  Biomedical  Center  of
Excellence, and a director of the Academic Entrepreneurship Center of Excellence for more than 6 years. He
taught  specific  courses  at  Jordan  University  of  Science  and  Technology  and  German  Jordanian  University.
His  research  over  the  last  eight  years  has  focused  on  biomedical  systems  engineering,  quality  assurance,
and entrepreneurship. Dr. Al-Fahoum holds a PhD in electrical engineering from Wisconsin University and
worked  in  international  and  national  research  companies.  Dr.  Al-Fahoum  has  served  as  principal
investigator on more than 12 graduate studentsâ€™ thesis and he is an author and co-author of more than 45
research articles. Dr. Al-Fahoum has served as a principal investigator in 16 industrial funded projects and
wrote  more  than  21  technical  reports.  Dr.  Al-Fahoum  taught  more  than  22  courses  and  supervised  more
than 500 students in their graduate and technical field training. Dr. AL-Fahoum is a civil servant  working
with many local and international business clubs, NGOs, and community based organizations.

Momtaz S. Abadir was born in Amman, Jordan, in 1990. He received the B.S. degree in
mechanical  and  aeronautical  engineering  from  Jordan  university  of  science  and
technology,  in  2013;  the  M.S.  degree  from  Cranfield  university-UK  in  aerospace
dynamics,  flight  dynamics,  in  2017.  He  worked  as  R&D  in  the Innovation  Center,  JUST
University from 2013-2015 and Feb.-Sept., 2017. He is currently a member in the faculty
stuff of the School of Engineering Technology (SET) at Al Hussein Technical University,
established by the Crown Prince Foundation.

He  has  over  3  years  of  hands-on  experience  in  design  and  development  of  different  research  projects
including:  modelling,  simulating  and  validating  linear,  nonlinear  air  vehicles  systems  using  MATLAB,
simulink,  data  analysis  by  means  of  signal  processing  and  the  ability  to  design  Kalman  Filter  (KF)  and
Extended  Kalman  Filter  (EKF);  practical  knowledge  of  aircraft  sensors  and  navigation  systems,  avionics,
sensor  calibration,  data  fusion  implementation  IMU,  AHRS,  MARG  and  GPS,  INS  based  on  different  filters
such  as  EKF  and  Madgwik;  experience  with  engineering  software  and  design  codes:  Matlab,  Simulink,
Arduino, Ansys, Fluent, Xflow, and Mechanical APDL.

View publication stats

International Journal of Computer Electrical Engineering186Volume 10, Number 3, September 2018
